* CHARMM input file for Multi-Site lambda-dynamics
* generated by msld_py_prep (JV,LC) for ALF (RLH)
*
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!  Multi-Site Lambda Dynamics 
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

set fnex = 5.5 
!!set sysname = jnk1
set builddir = prep
set box = ????
set temp = 298.15
set ligseg = lig
set resnum = 1

! perturbation variables
set nsites = 1 
set nsubs1 = 3 
set nblocks = 3 

bomblev -2

!! Read in toppar stream file
stream @builddir/toppar.str

read rtf append card name @builddir/core.rtf
read param flex append card name @builddir/full_ligand.prm

!! !! Reads coordinates and pdb file for the protein
!! read sequ pdb name @builddir/protein.pdb
!! generate SEGID first NTER last CTER setup warn
!! read coor pdb resid name @builddir/protein.pdb
!! 
!! ic generate
!! ic param
!! ic build 
!! hbuild sele hydrogen end
!! auto angle dihe

!! Reads coordinates and pdb file for the ligand
read sequ pdb name @builddir/core.pdb
generate @ligseg setup
read coor pdb resid name @builddir/core.pdb

!! Read in the ligand patch rtf files
read rtf append card name @builddir/site1_sub1_pres.rtf
read rtf append card name @builddir/site1_sub2_pres.rtf
read rtf append card name @builddir/site1_sub3_pres.rtf

!! Read in the ligand fragment pdb files
ic generate

patch p1_1 @ligseg @resnum setup
read coor pdb resid name @builddir/site1_sub1_frag.pdb
ic param
ic build

patch p1_2 @ligseg @resnum setup
read coor pdb resid name @builddir/site1_sub2_frag.pdb
ic param
ic build

patch p1_3 @ligseg @resnum setup
read coor pdb resid name @builddir/site1_sub3_frag.pdb
ic param
ic build

!! Read in LonePair sites (if applicable)
stream @builddir/lpsites.inp

!! Define MSLD substituent selections
define site1_sub1 - 
   select ( - 
   atom @ligseg @resnum O027 .or. -
   atom @ligseg @resnum C028 .or. -
   atom @ligseg @resnum C029 .or. -
   atom @ligseg @resnum H030 .or. -
   atom @ligseg @resnum H031 .or. -
   atom @ligseg @resnum C032 .or. -
   atom @ligseg @resnum H033 .or. -
   atom @ligseg @resnum H034 .or. -
   atom @ligseg @resnum H035 .or. -
   none ) end

define site1_sub2 - 
   select ( - 
   atom @ligseg @resnum O036 .or. -
   atom @ligseg @resnum C037 .or. -
   atom @ligseg @resnum C038 .or. -
   atom @ligseg @resnum H039 .or. -
   atom @ligseg @resnum C040 .or. -
   atom @ligseg @resnum H041 .or. -
   atom @ligseg @resnum H042 .or. -
   atom @ligseg @resnum H043 .or. -
   atom @ligseg @resnum C044 .or. -
   atom @ligseg @resnum H045 .or. -
   atom @ligseg @resnum H046 .or. -
   atom @ligseg @resnum H047 .or. -
   none ) end

define site1_sub3 - 
   select ( - 
   atom @ligseg @resnum O048 .or. -
   atom @ligseg @resnum C049 .or. -
   atom @ligseg @resnum C050 .or. -
   atom @ligseg @resnum H051 .or. -
   atom @ligseg @resnum C052 .or. -
   atom @ligseg @resnum H053 .or. -
   atom @ligseg @resnum H054 .or. -
   atom @ligseg @resnum C055 .or. -
   atom @ligseg @resnum H056 .or. -
   atom @ligseg @resnum H057 .or. -
   atom @ligseg @resnum C058 .or. -
   atom @ligseg @resnum H059 .or. -
   atom @ligseg @resnum H060 .or. -
   none ) end

auto angle dihe  !! do not call after deleting sub-sub terms or loading in water
bomblev -1

! delete angles and dihedrals between alchem groups
set ii = 1
label deletesiteloop
if @ii .le. @nsites then

   set jj = 1
   label delete1loop
   if @jj .le. @nsubs@@ii then

      calc kk = @jj + 1
      label delete2loop
      if @kk .le. @nsubs@@ii then

         dele connectivity sele ( site@{ii}_sub@@jj ) show end sele ( site@{ii}_sub@@kk ) show end
         calc kk = @kk + 1
         goto delete2loop
      endif

      calc jj = @jj + 1
      goto delete1loop
   endif

   calc ii = @ii + 1
   goto deletesiteloop
endif

!! ! System specific deletion (linear groups)
!! dele dihe sele (atom LIG 1 ATOMNAME) show end

!! Load solvent
read sequ pdb name @builddir/solvent.pdb
generate WT00 first none last none setup noangl nodihe
read coor pdb resid name @builddir/solvent.pdb

!! !! Load ions
!! read sequ pdb name @builddir/ions.pdb
!! generate HETA first none last none setup noangl nodihe
!! read coor pdb resid name @builddir/ions.pdb

print coor sele .not. init end

bomblev 0

!! !! Write Initial System to Disk
!! write psf card name patch.psf
!! * patch psf file
!! *
!! write coor pdb card name patch.pdb
!! * patch pdb file
!! *
!! write coor card name patch.crd
!! * patch crd file
!! *

!! Create water box & periodic images
coor stat
crystal define cubic @box @box @box 90. 90. 90.
crystal build cutoff 14 nope 0
image byres xcen 0 ycen 0 zcen 0 sele resn tip3 .or. resn sod .or. resn cla end
image byseg xcen 0 ycen 0 zcen 0 sele .not. ( resn tip3 .or. resn sod .or. resn cla ) end

!! Copy main coords into comp set
cons harm clear
coor copy comp

! LDBI math: for every "pair" there are 5 ldbi's
set ii = 1
set ldbibias = 0
label ldbimathloop
if @ii .le. @nsites then
   calc ldbibias = @ldbibias + ( ( @nsubs@@ii * (@nsubs@@ii - 1) / 2 ) * 5 )
   INCR ii by 1
   goto ldbimathloop
endif
set charge = ?cgtot

calc blockplusone = @nblocks + 1

!! BLOCK setup
BLOCK @blockplusone
   clear
END
BLOCK @blockplusone !RX! NREP @nreps
   Call 2 sele site1_sub1 show end
   Call 3 sele site1_sub2 show end
   Call 4 sele site1_sub3 show end

   qldm theta
   lang temp @temp
   !RX! phmd ph 7
   soft on   ! this turns on soft-cores
   pmel ex   ! this turns on PME

   ldin 1 1.0  0.0  5.0  0.0  5.0
   ldin 2  0.3333 0.0  5.0  @lams1s1 5.0 !RX! NONE
   ldin 3  0.3333 0.0  5.0  @lams1s2 5.0 !RX! UNEG 7.0
   ldin 4  0.3333 0.0  5.0  @lams1s3 5.0 !RX! UPOS 7.0

   set excl1 = 2 3 2 4 3 4
   excl @excl1

   !!rmla bond thet dihe impr 
   rmla bond thet impr 
   msld 0  1  1  1  fnex @fnex
   msma

   ! Check block.doc for functional form of these biasing potentials
   calc nbiaspot = 5 * ( @nblocks * ( @nblocks - 1 ) ) / 2
   ldbi @nbiaspot
   set ibias = 1
   set iblock = 0
   set si = 1
   label loop5_vb
   if @si .le. @nsites then
      set jblock = @iblock
      set sj = @si
      label loop5b_vb
      if @sj .le. @nsites then
         set ii = 1
         label loop6_vb
         if @ii .le. @nsubs@@{si} then
            calc ip1 = @ii + 1 + @iblock
            set jj = 1
            if @si .eq. @sj then
               calc jj = @ii + 1
            endif
            label loop7_vb
            if @jj .le. @nsubs@@{sj} then
               calc jp1 = @jj + 1 + @jblock
   
               set c_shift = 0.0
               set x_shift = 0.0
               set s_shift = 0.0
               !vbrex! if @si .eq. @sj then
               !vbrex!    calc c_shift = 1.2 * (@myrep - @ncentral)
               !vbrex!    calc s_shift = 0.3 * (@myrep - @ncentral)
               !vbrex! endif
   
               calc coeff = @cs@@{si}s@@{ii}s@@{sj}s@@{jj} + @{c_shift}
               ldbv @ibias @ip1 @jp1 6 0.0 @coeff 0
               calc ibias = @ibias + 1
               calc coeff = @xs@@{si}s@@{ii}s@@{sj}s@@{jj} + @{x_shift}
               ldbv @ibias @ip1 @jp1 10 -5.56 @coeff 0
               calc ibias = @ibias + 1
               calc coeff = @ss@@{si}s@@{ii}s@@{sj}s@@{jj} + @{s_shift}
               ldbv @ibias @ip1 @jp1 8 0.017 @coeff 0
               calc ibias = @ibias + 1
               calc coeff = @xs@@{sj}s@@{jj}s@@{si}s@@{ii} + @{x_shift}
               ldbv @ibias @jp1 @ip1 10 -5.56 @coeff 0
               calc ibias = @ibias + 1
               calc coeff = @ss@@{sj}s@@{jj}s@@{si}s@@{ii} + @{s_shift}
               ldbv @ibias @jp1 @ip1 8 0.017 @coeff 0
               calc ibias = @ibias + 1
               calc jj = @jj + 1
               goto loop7_vb
            endif
            calc ii = @ii + 1
            goto loop6_vb
         endif
         calc jblock = @jblock + @nsubs@@{sj}
         calc sj = @sj + 1
         goto loop5b_vb
      endif
      calc iblock = @iblock + @nsubs@@{si}
      calc si = @si + 1
      goto loop5_vb
   endif
END

!! !! Set NOE distance restraints
!! NOE
!!    RESET
!! END
!! 
!! faster on
!! !! set up energy parameters if you want to use NOEs
!! nbonds atom fswitch vdw vfswitch cdie eps 1 -
!!     cutnb 14.0 cutim 14.0 ctonnb 10.0 ctofnb 12.0

!! energy
!! NOE
!! ! Site 1
!!    assign sele atom LIG 1 Atom1 end sele atom LIG 1 Atom2 end -
!!    kmin 1.0 rmin 0.0 kmax 1.0 rmax 0.2 fmax 2.0 rswitch 2.0 sexp 1.0
!! 
!!    print anal
!! END


